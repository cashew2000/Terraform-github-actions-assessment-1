#name: Terraform EC2 Deployment 

#on:
#  workflow_dispatch:
#    inputs:
 #     stage:
 #       description: "Stage (dev/prod)"
   #     required: true
  #      default: "dev"
  #    auto_stop_minutes:
   #     description: "Minutes after which EC2 should shut down (0 to disable)"
   #     required: false
   #     default: "60"

#jobs:
# deploy:
#    runs-on: ubuntu-latest

#    steps:
 #     - name: Checkout repository
 #       uses: actions/checkout@v4

 #     - name: Setup Terraform
 #       uses: hashicorp/setup-terraform@v2

  #    - name: Configure AWS credentials
  #      uses: aws-actions/configure-aws-credentials@v2
  #      with:
  #        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
   #       aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
   #       aws-region: ap-southeast-2

 #     - name: Terraform Init
 #       run: terraform init

  #    - name: Terraform Apply
 #       run: terraform apply -auto-approve -var="stage=${{ github.event.inputs.stage }}" -var="auto_stop_minutes=${{ github.event.inputs.auto_stop_minutes }}"
          
          
 #     - name: Show Terraform Outputs
#        run: terraform output

name: DevOps Assignment 3 – Pipeline Wiring (Safe Mode)

on:
  push:
    branches:
      - main
      - assessment-2
    tags:
      - deploy-prod*
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # -----------------------------
      # Checkout repository
      # -----------------------------
      - name: Checkout code
        uses: actions/checkout@v4

      # -----------------------------
      # Determine deployment stage
      # -----------------------------
      - name: Determine deployment stage
        id: stage
        run: |
          echo "GITHUB_REF=${GITHUB_REF}"

          if [[ "${GITHUB_REF}" == "refs/heads/main" ]] || [[ "${GITHUB_REF}" == "refs/heads/assessment-3" ]]; then
            echo "stage=dev" >> $GITHUB_OUTPUT
          elif [[ "${GITHUB_REF}" == refs/tags/deploy-prod* ]]; then
            echo "stage=prod" >> $GITHUB_OUTPUT
          else
            echo "Unsupported ref: ${GITHUB_REF}"
            exit 1
          fi

      - name: Show detected stage
        run: echo "Deployment stage is ${{ steps.stage.outputs.stage }}"

      # -----------------------------
      # Setup SSH (private key from secrets)
      # -----------------------------
      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa

          # Prevent SSH host verification issues later
          ssh-keyscan -H github.com >> ~/.ssh/known_hosts

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}
      # -----------------------------
      # Setup Terraform
      # -----------------------------
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3

      # -----------------------------
      # Terraform Init
      # -----------------------------
      - name: Terraform Init
        run: terraform init

      # -----------------------------
      # Terraform Validate
      # -----------------------------
      - name: Terraform Validate
        run: terraform validate

      # -----------------------------
      # Terraform Plan (NO APPLY)
      # -----------------------------
      - name: Terraform Plan (safe – no apply)
        run: |
          terraform plan \
            -var="stage=${{ steps.stage.outputs.stage }}"

      #- name: Terraform Apply
      #  run: terraform apply -auto-approve

      - name: Set EC2 Public IP (temporary)
        run: |
          echo "EC2_PUBLIC_IP=3.27.105.135" >> $GITHUB_ENV
          echo "Using EC2 IP: 3.27.105.135"

       
      # -----------------------------
      # Placeholder for SSH Deployment
      # -----------------------------
      - name: Deploy application over SSH + upload logs to S3
        run: |
         ssh -o StrictHostKeyChecking=no ubuntu@$EC2_PUBLIC_IP << 'EOF'
         set -e

          STAGE="${{ steps.stage.outputs.stage }}"
          APP_DIR="/home/ubuntu/app"
          DEPLOY_LOG="$APP_DIR/deploy.log"
          APP_LOG="$APP_DIR/app.log"

          INSTANCE_ID=$(curl -s http://169.254.169.254/latest/meta-data/instance-id)
          BUCKET_NAME="dev-logs-edc6f26c"
          S3_PATH="s3://${BUCKET_NAME}/logs/${STAGE}/${INSTANCE_ID}"

          echo "[INFO] Connected to EC2" | tee -a $DEPLOY_LOG

          cd /home/ubuntu

          if [ ! -d app ]; then
          echo "[INFO] Cloning repository" | tee -a $DEPLOY_LOG
          git clone https://github.com/techeazy-consulting/techeazy-devops app
          fi

          cd app
          echo "[INFO] Pulling latest code" | tee -a $DEPLOY_LOG
          git pull >> $DEPLOY_LOG 2>&1

          echo "[INFO] Building application" | tee -a $DEPLOY_LOG
          mvn clean package >> $DEPLOY_LOG 2>&1

          echo "[INFO] Restarting application" | tee -a $DEPLOY_LOG
          sudo pkill -f java || true

          nohup sudo java -jar target/*.jar --server.port=80 > $APP_LOG 2>&1 &

          sleep 5

          echo "[INFO] Uploading logs to S3: $S3_PATH" | tee -a $DEPLOY_LOG
          aws s3 cp $DEPLOY_LOG $S3_PATH/deploy.log
          aws s3 cp $APP_LOG $S3_PATH/app.log

          echo "[INFO] Deployment completed successfully" | tee -a $DEPLOY_LOG
          EOF

      - name: Health Check (HTTP 80)
        run: |
          echo "Checking app on http://$EC2_PUBLIC_IP"

          for i in {1..30}; do
          if curl -s http://$EC2_PUBLIC_IP > /dev/null; then
          echo "✅ Application is reachable"
          exit 0
          fi
          echo "Attempt $i failed, retrying..."
          sleep 5
          done

          echo "❌ Application failed health check"
          exit 1


      # -----------------------------
      # IMPORTANT:
      # terraform apply is intentionally disabled
      # for Assignment 3 pipeline wiring
      # -----------------------------
      # - name: Terraform Apply
      #   run: terraform apply -auto-approve
